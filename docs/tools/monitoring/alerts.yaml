groups:
- name: formal-framework-alerts
  rules:
  # 应用服务告警
  - alert: AppDown
    expr: up{job="formal-framework-app"} == 0
    for: 1m
    labels:
      severity: critical
      service: app
      team: platform
    annotations:
      summary: "应用服务不可用"
      description: "应用服务 {{ $labels.instance }} 已宕机超过1分钟"
      runbook_url: "https://wiki.formal-framework.com/runbooks/app-down"

  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
    for: 5m
    labels:
      severity: critical
      service: app
      team: platform
    annotations:
      summary: "高错误率告警"
      description: "应用服务错误率为 {{ $value }} 错误/秒，超过阈值 0.1"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-error-rate"

  - alert: HighResponseTime
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
    for: 5m
    labels:
      severity: warning
      service: app
      team: platform
    annotations:
      summary: "高响应时间告警"
      description: "应用服务95分位响应时间为 {{ $value }} 秒，超过阈值 1秒"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-response-time"

  - alert: LowThroughput
    expr: rate(http_requests_total[5m]) < 10
    for: 10m
    labels:
      severity: warning
      service: app
      team: platform
    annotations:
      summary: "低吞吐量告警"
      description: "应用服务吞吐量为 {{ $value }} 请求/秒，低于阈值 10"
      runbook_url: "https://wiki.formal-framework.com/runbooks/low-throughput"

  # 数据库告警
  - alert: DatabaseDown
    expr: up{job="postgres"} == 0
    for: 1m
    labels:
      severity: critical
      service: database
      team: platform
    annotations:
      summary: "数据库不可用"
      description: "PostgreSQL数据库 {{ $labels.instance }} 已宕机超过1分钟"
      runbook_url: "https://wiki.formal-framework.com/runbooks/database-down"

  - alert: DatabaseHighConnections
    expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
    for: 5m
    labels:
      severity: warning
      service: database
      team: platform
    annotations:
      summary: "数据库连接数过高"
      description: "数据库连接数使用率为 {{ $value | humanizePercentage }}，超过阈值 80%"
      runbook_url: "https://wiki.formal-framework.com/runbooks/database-high-connections"

  - alert: DatabaseSlowQueries
    expr: rate(pg_stat_database_tup_returned[5m]) / rate(pg_stat_database_tup_fetched[5m]) < 0.1
    for: 10m
    labels:
      severity: warning
      service: database
      team: platform
    annotations:
      summary: "数据库慢查询告警"
      description: "数据库查询效率低，返回/获取比率为 {{ $value }}"
      runbook_url: "https://wiki.formal-framework.com/runbooks/database-slow-queries"

  # Redis告警
  - alert: RedisDown
    expr: up{job="redis"} == 0
    for: 1m
    labels:
      severity: critical
      service: redis
      team: platform
    annotations:
      summary: "Redis不可用"
      description: "Redis服务 {{ $labels.instance }} 已宕机超过1分钟"
      runbook_url: "https://wiki.formal-framework.com/runbooks/redis-down"

  - alert: RedisHighMemoryUsage
    expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
    for: 5m
    labels:
      severity: warning
      service: redis
      team: platform
    annotations:
      summary: "Redis内存使用率过高"
      description: "Redis内存使用率为 {{ $value | humanizePercentage }}，超过阈值 80%"
      runbook_url: "https://wiki.formal-framework.com/runbooks/redis-high-memory"

  - alert: RedisHighKeyExpiration
    expr: rate(redis_keyspace_expires_total[5m]) > 1000
    for: 5m
    labels:
      severity: warning
      service: redis
      team: platform
    annotations:
      summary: "Redis键过期率过高"
      description: "Redis键过期率为 {{ $value }} 键/秒，超过阈值 1000"
      runbook_url: "https://wiki.formal-framework.com/runbooks/redis-high-expiration"

  # 系统资源告警
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
      service: system
      team: platform
    annotations:
      summary: "CPU使用率过高"
      description: "节点 {{ $labels.instance }} CPU使用率为 {{ $value }}%，超过阈值 80%"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-cpu-usage"

  - alert: HighMemoryUsage
    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
    for: 5m
    labels:
      severity: warning
      service: system
      team: platform
    annotations:
      summary: "内存使用率过高"
      description: "节点 {{ $labels.instance }} 内存使用率为 {{ $value }}%，超过阈值 85%"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-memory-usage"

  - alert: HighDiskUsage
    expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 90
    for: 5m
    labels:
      severity: critical
      service: system
      team: platform
    annotations:
      summary: "磁盘使用率过高"
      description: "节点 {{ $labels.instance }} 磁盘使用率为 {{ $value }}%，超过阈值 90%"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-disk-usage"

  - alert: DiskSpaceLow
    expr: node_filesystem_avail_bytes < 1073741824  # 1GB
    for: 1m
    labels:
      severity: critical
      service: system
      team: platform
    annotations:
      summary: "磁盘空间不足"
      description: "节点 {{ $labels.instance }} 磁盘剩余空间为 {{ $value | humanizeBytes }}，低于阈值 1GB"
      runbook_url: "https://wiki.formal-framework.com/runbooks/disk-space-low"

  # 容器告警
  - alert: ContainerCrashLooping
    expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
    for: 5m
    labels:
      severity: critical
      service: kubernetes
      team: platform
    annotations:
      summary: "容器崩溃循环"
      description: "容器 {{ $labels.pod }} 在15分钟内重启了 {{ $value }} 次"
      runbook_url: "https://wiki.formal-framework.com/runbooks/container-crash-looping"

  - alert: ContainerHighMemoryUsage
    expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.8
    for: 5m
    labels:
      severity: warning
      service: kubernetes
      team: platform
    annotations:
      summary: "容器内存使用率过高"
      description: "容器 {{ $labels.pod }} 内存使用率为 {{ $value | humanizePercentage }}，超过阈值 80%"
      runbook_url: "https://wiki.formal-framework.com/runbooks/container-high-memory"

  - alert: ContainerHighCPUUsage
    expr: (rate(container_cpu_usage_seconds_total[5m]) / container_spec_cpu_quota * container_spec_cpu_period) > 0.8
    for: 5m
    labels:
      severity: warning
      service: kubernetes
      team: platform
    annotations:
      summary: "容器CPU使用率过高"
      description: "容器 {{ $labels.pod }} CPU使用率为 {{ $value | humanizePercentage }}，超过阈值 80%"
      runbook_url: "https://wiki.formal-framework.com/runbooks/container-high-cpu"

  # 网络告警
  - alert: HighNetworkErrors
    expr: rate(node_network_receive_errs_total[5m]) + rate(node_network_transmit_errs_total[5m]) > 10
    for: 5m
    labels:
      severity: warning
      service: network
      team: platform
    annotations:
      summary: "网络错误率过高"
      description: "节点 {{ $labels.instance }} 网络错误率为 {{ $value }} 错误/秒，超过阈值 10"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-network-errors"

  - alert: HighNetworkDrops
    expr: rate(node_network_receive_drop_total[5m]) + rate(node_network_transmit_drop_total[5m]) > 10
    for: 5m
    labels:
      severity: warning
      service: network
      team: platform
    annotations:
      summary: "网络丢包率过高"
      description: "节点 {{ $labels.instance }} 网络丢包率为 {{ $value }} 包/秒，超过阈值 10"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-network-drops"

  # 业务指标告警
  - alert: LowUserActivity
    expr: rate(user_activity_total[1h]) < 100
    for: 30m
    labels:
      severity: warning
      service: business
      team: product
    annotations:
      summary: "用户活跃度低"
      description: "用户活跃度为 {{ $value }} 活动/小时，低于阈值 100"
      runbook_url: "https://wiki.formal-framework.com/runbooks/low-user-activity"

  - alert: HighTransactionFailureRate
    expr: rate(transaction_failures_total[5m]) / rate(transaction_total[5m]) > 0.05
    for: 5m
    labels:
      severity: critical
      service: business
      team: product
    annotations:
      summary: "交易失败率过高"
      description: "交易失败率为 {{ $value | humanizePercentage }}，超过阈值 5%"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-transaction-failure-rate"

  - alert: DataConsistencyIssue
    expr: data_consistency_check_failures_total > 0
    for: 1m
    labels:
      severity: critical
      service: business
      team: platform
    annotations:
      summary: "数据一致性问题"
      description: "检测到数据一致性问题，失败次数: {{ $value }}"
      runbook_url: "https://wiki.formal-framework.com/runbooks/data-consistency-issue"

  # 安全告警
  - alert: HighFailedLoginAttempts
    expr: rate(login_failures_total[5m]) > 10
    for: 5m
    labels:
      severity: warning
      service: security
      team: security
    annotations:
      summary: "登录失败次数过高"
      description: "登录失败率为 {{ $value }} 失败/秒，超过阈值 10"
      runbook_url: "https://wiki.formal-framework.com/runbooks/high-failed-login-attempts"

  - alert: SuspiciousActivity
    expr: rate(suspicious_activity_total[5m]) > 5
    for: 5m
    labels:
      severity: critical
      service: security
      team: security
    annotations:
      summary: "可疑活动检测"
      description: "检测到可疑活动，活动率为 {{ $value }} 活动/秒，超过阈值 5"
      runbook_url: "https://wiki.formal-framework.com/runbooks/suspicious-activity"

  # 依赖服务告警
  - alert: ExternalServiceDown
    expr: up{job="blackbox"} == 0
    for: 2m
    labels:
      severity: critical
      service: external
      team: platform
    annotations:
      summary: "外部服务不可用"
      description: "外部服务 {{ $labels.instance }} 不可用超过2分钟"
      runbook_url: "https://wiki.formal-framework.com/runbooks/external-service-down"

  - alert: ExternalServiceSlow
    expr: probe_duration_seconds > 5
    for: 5m
    labels:
      severity: warning
      service: external
      team: platform
    annotations:
      summary: "外部服务响应慢"
      description: "外部服务 {{ $labels.instance }} 响应时间为 {{ $value }} 秒，超过阈值 5秒"
      runbook_url: "https://wiki.formal-framework.com/runbooks/external-service-slow"
