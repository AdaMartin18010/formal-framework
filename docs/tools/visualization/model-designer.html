<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正式验证框架 - 模型设计器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #design-canvas {
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            cursor: crosshair;
        }

        .tool-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .tool-button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .tool-button.active {
            background: #764ba2;
        }

        .component-palette {
            margin-bottom: 20px;
        }

        .palette-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .component-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
        }

        .component-item:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .component-item:active {
            cursor: grabbing;
        }

        .properties-panel {
            margin-top: 20px;
        }

        .property-group {
            margin-bottom: 15px;
        }

        .property-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .property-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .model-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-title {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-item {
            margin: 5px 0;
            color: #555;
        }

        .status-bar {
            height: 30px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            min-width: 400px;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="model-info">
                <div class="info-title">模型信息</div>
                <div class="info-item">名称: <span id="model-name">未命名模型</span></div>
                <div class="info-item">类型: <span id="model-type">交互模型</span></div>
                <div class="info-item">组件数: <span id="component-count">0</span></div>
                <div class="info-item">状态: <span id="model-status">编辑中</span></div>
            </div>

            <div class="component-palette">
                <div class="palette-title">组件库</div>
                <div class="component-item" data-type="actor">参与者</div>
                <div class="component-item" data-type="process">进程</div>
                <div class="component-item" data-type="data">数据</div>
                <div class="component-item" data-type="interface">接口</div>
                <div class="component-item" data-type="service">服务</div>
                <div class="component-item" data-type="database">数据库</div>
            </div>

            <div class="properties-panel">
                <div class="palette-title">属性面板</div>
                <div class="property-group">
                    <label class="property-label">组件名称</label>
                    <input type="text" class="property-input" id="component-name" placeholder="输入组件名称">
                </div>
                <div class="property-group">
                    <label class="property-label">组件类型</label>
                    <select class="property-input" id="component-type">
                        <option value="actor">参与者</option>
                        <option value="process">进程</option>
                        <option value="data">数据</option>
                        <option value="interface">接口</option>
                        <option value="service">服务</option>
                        <option value="database">数据库</option>
                    </select>
                </div>
                <div class="property-group">
                    <label class="property-label">描述</label>
                    <textarea class="property-input" id="component-description" rows="3" placeholder="输入组件描述"></textarea>
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 工具栏 -->
            <div class="toolbar">
                <button class="tool-button active" data-tool="select">选择</button>
                <button class="tool-button" data-tool="move">移动</button>
                <button class="tool-button" data-tool="connect">连接</button>
                <button class="tool-button" data-tool="delete">删除</button>
                <div style="flex: 1;"></div>
                <button class="tool-button" id="save-model">保存</button>
                <button class="tool-button" id="load-model">加载</button>
                <button class="tool-button" id="export-model">导出</button>
                <button class="tool-button" id="validate-model">验证</button>
            </div>

            <!-- 画布 -->
            <div class="canvas-container">
                <canvas id="design-canvas"></canvas>
            </div>

            <!-- 状态栏 -->
            <div class="status-bar">
                <span>就绪 | 坐标: (0, 0) | 缩放: 100%</span>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div class="modal" id="save-modal">
        <div class="modal-content">
            <div class="modal-header">保存模型</div>
            <div class="property-group">
                <label class="property-label">模型名称</label>
                <input type="text" class="property-input" id="save-name" placeholder="输入模型名称">
            </div>
            <div class="property-group">
                <label class="property-label">描述</label>
                <textarea class="property-input" id="save-description" rows="3" placeholder="输入模型描述"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('save-modal')">取消</button>
                <button class="btn btn-primary" onclick="saveModel()">保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="load-modal">
        <div class="modal-content">
            <div class="modal-header">加载模型</div>
            <div class="property-group">
                <label class="property-label">选择模型</label>
                <select class="property-input" id="load-select">
                    <option value="">选择要加载的模型</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('load-modal')">取消</button>
                <button class="btn btn-primary" onclick="loadModel()">加载</button>
            </div>
        </div>
    </div>

    <script>
        class ModelDesigner {
            constructor() {
                this.canvas = document.getElementById('design-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.components = [];
                this.selectedComponent = null;
                this.currentTool = 'select';
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                
                this.setupCanvas();
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.resizeCanvas();
            }

            setupCanvas() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.redraw();
            }

            setupEventListeners() {
                // 工具栏事件
                document.querySelectorAll('.tool-button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (e.target.dataset.tool) {
                            this.setTool(e.target.dataset.tool);
                        }
                    });
                });

                // 画布事件
                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.onMouseUp(e));

                // 按钮事件
                document.getElementById('save-model').addEventListener('click', () => this.showSaveModal());
                document.getElementById('load-model').addEventListener('click', () => this.showLoadModal());
                document.getElementById('export-model').addEventListener('click', () => this.exportModel());
                document.getElementById('validate-model').addEventListener('click', () => this.validateModel());

                // 属性面板事件
                document.getElementById('component-name').addEventListener('input', (e) => this.updateComponentProperty('name', e.target.value));
                document.getElementById('component-type').addEventListener('change', (e) => this.updateComponentProperty('type', e.target.value));
                document.getElementById('component-description').addEventListener('input', (e) => this.updateComponentProperty('description', e.target.value));
            }

            setupDragAndDrop() {
                document.querySelectorAll('.component-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', item.dataset.type);
                    });
                });

                this.canvas.addEventListener('dragover', (e) => e.preventDefault());
                this.canvas.addEventListener('drop', (e) => this.onDrop(e));
            }

            setTool(tool) {
                this.currentTool = tool;
                document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
                
                this.canvas.style.cursor = tool === 'select' ? 'default' : 
                                         tool === 'move' ? 'move' : 
                                         tool === 'connect' ? 'crosshair' : 
                                         tool === 'delete' ? 'not-allowed' : 'default';
            }

            onMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (this.currentTool === 'select') {
                    this.selectedComponent = this.getComponentAt(x, y);
                    if (this.selectedComponent) {
                        this.isDragging = true;
                        this.dragOffset = {
                            x: x - this.selectedComponent.x,
                            y: y - this.selectedComponent.y
                        };
                        this.updatePropertiesPanel();
                    }
                } else if (this.currentTool === 'delete' && this.selectedComponent) {
                    this.deleteComponent(this.selectedComponent);
                }

                this.redraw();
            }

            onMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (this.isDragging && this.selectedComponent) {
                    this.selectedComponent.x = x - this.dragOffset.x;
                    this.selectedComponent.y = y - this.dragOffset.y;
                    this.redraw();
                }

                // 更新状态栏
                document.querySelector('.status-bar span').textContent = 
                    `就绪 | 坐标: (${Math.round(x)}, ${Math.round(y)}) | 缩放: 100%`;
            }

            onMouseUp(e) {
                this.isDragging = false;
            }

            onDrop(e) {
                e.preventDefault();
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const type = e.dataTransfer.getData('text/plain');

                this.addComponent(type, x, y);
            }

            addComponent(type, x, y) {
                const component = {
                    id: Date.now(),
                    type: type,
                    name: `${type}_${this.components.length + 1}`,
                    x: x,
                    y: y,
                    width: 100,
                    height: 60,
                    description: ''
                };

                this.components.push(component);
                this.selectedComponent = component;
                this.updatePropertiesPanel();
                this.updateModelInfo();
                this.redraw();
            }

            deleteComponent(component) {
                const index = this.components.indexOf(component);
                if (index > -1) {
                    this.components.splice(index, 1);
                    this.selectedComponent = null;
                    this.updatePropertiesPanel();
                    this.updateModelInfo();
                    this.redraw();
                }
            }

            getComponentAt(x, y) {
                for (let i = this.components.length - 1; i >= 0; i--) {
                    const comp = this.components[i];
                    if (x >= comp.x && x <= comp.x + comp.width &&
                        y >= comp.y && y <= comp.y + comp.height) {
                        return comp;
                    }
                }
                return null;
            }

            updateComponentProperty(property, value) {
                if (this.selectedComponent) {
                    this.selectedComponent[property] = value;
                    this.updateModelInfo();
                    this.redraw();
                }
            }

            updatePropertiesPanel() {
                if (this.selectedComponent) {
                    document.getElementById('component-name').value = this.selectedComponent.name;
                    document.getElementById('component-type').value = this.selectedComponent.type;
                    document.getElementById('component-description').value = this.selectedComponent.description;
                } else {
                    document.getElementById('component-name').value = '';
                    document.getElementById('component-type').value = 'actor';
                    document.getElementById('component-description').value = '';
                }
            }

            updateModelInfo() {
                document.getElementById('component-count').textContent = this.components.length;
            }

            redraw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 绘制网格
                this.drawGrid();
                
                // 绘制组件
                this.components.forEach(component => {
                    this.drawComponent(component);
                });
            }

            drawGrid() {
                const gridSize = 20;
                this.ctx.strokeStyle = '#e0e0e0';
                this.ctx.lineWidth = 1;

                for (let x = 0; x < this.canvas.width; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }

                for (let y = 0; y < this.canvas.height; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
            }

            drawComponent(component) {
                const isSelected = component === this.selectedComponent;
                
                // 设置颜色
                const colors = {
                    actor: '#4CAF50',
                    process: '#2196F3',
                    data: '#FF9800',
                    interface: '#9C27B0',
                    service: '#F44336',
                    database: '#607D8B'
                };

                this.ctx.fillStyle = colors[component.type] || '#666';
                this.ctx.strokeStyle = isSelected ? '#FF5722' : '#333';
                this.ctx.lineWidth = isSelected ? 3 : 2;

                // 绘制矩形
                this.ctx.fillRect(component.x, component.y, component.width, component.height);
                this.ctx.strokeRect(component.x, component.y, component.width, component.height);

                // 绘制文本
                this.ctx.fillStyle = 'white';
                this.ctx.font = '12px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(
                    component.name,
                    component.x + component.width / 2,
                    component.y + component.height / 2 + 4
                );
            }

            showSaveModal() {
                document.getElementById('save-modal').style.display = 'block';
            }

            showLoadModal() {
                // 这里应该从服务器加载模型列表
                document.getElementById('load-modal').style.display = 'block';
            }

            saveModel() {
                const name = document.getElementById('save-name').value;
                const description = document.getElementById('save-description').value;
                
                if (!name) {
                    alert('请输入模型名称');
                    return;
                }

                const modelData = {
                    name: name,
                    description: description,
                    components: this.components,
                    timestamp: new Date().toISOString()
                };

                // 保存到本地存储
                localStorage.setItem(`model_${name}`, JSON.stringify(modelData));
                
                // 更新模型信息
                document.getElementById('model-name').textContent = name;
                document.getElementById('model-status').textContent = '已保存';
                
                closeModal('save-modal');
                alert('模型保存成功！');
            }

            loadModel() {
                const modelName = document.getElementById('load-select').value;
                if (!modelName) {
                    alert('请选择要加载的模型');
                    return;
                }

                const modelData = JSON.parse(localStorage.getItem(`model_${modelName}`));
                if (modelData) {
                    this.components = modelData.components || [];
                    document.getElementById('model-name').textContent = modelData.name;
                    document.getElementById('model-status').textContent = '已加载';
                    this.updateModelInfo();
                    this.redraw();
                    closeModal('load-modal');
                }
            }

            exportModel() {
                const modelData = {
                    name: document.getElementById('model-name').textContent,
                    components: this.components,
                    timestamp: new Date().toISOString()
                };

                const dataStr = JSON.stringify(modelData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `${modelData.name}.json`;
                link.click();
            }

            validateModel() {
                const errors = [];
                
                if (this.components.length === 0) {
                    errors.push('模型至少需要一个组件');
                }

                this.components.forEach((comp, index) => {
                    if (!comp.name) {
                        errors.push(`组件 ${index + 1} 缺少名称`);
                    }
                });

                if (errors.length === 0) {
                    alert('模型验证通过！');
                } else {
                    alert('模型验证失败：\n' + errors.join('\n'));
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 初始化设计器
        const designer = new ModelDesigner();
    </script>
</body>
</html>
